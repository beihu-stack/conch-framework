## Redis统计方案

### 场景：

- 在移动应用中，需要统计每天的新增用户数和第二天的留存用户数；
- 在电商网站的商品评论中，需要统计评论列表中的最新评论；
- 在签到打卡中，需要统计一个月内连续打卡的用户数；
- 在网页访问记录中，需要统计独立访客（Unique Visitor，UV）量。



### 集合统计模式

##### 聚合统计

> 交集，并集，差集，补集，对称差集

<img src="assets/image-20211026204011952.png" alt="image-20211026204011952" style="zoom:35%;" />



- 一个Set集合，存放所有登录用户id
  - key：`user:id`
  - value: ["001","002"]
- 每日一个Set，存放每日登录用户id
  - key：`user:id:20211025`
  - value:["002","003"]

新增用户数：使用差集

- 先计算差集，然后将今日新增数据 添加到 所有登录用户id集合中
- SDIFFSTORE   `user:new`     `user:id:20211025`    `user:id`

第二天留存数：交集

- SINTERSTORE   `user:rem`     `user:id:20211025`    `user:id:20211026`

*并集命令：SUNION*

**问题**：Set集合在做聚合计算时，消耗比较大，数据量大时，会导致Redis实例阻塞，建议 **在主从集群中选择一个从库专门负责聚合计算，或者将数据读取到客户端进行聚合**



##### 排序统计

