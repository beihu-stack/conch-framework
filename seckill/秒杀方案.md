## 秒杀方案

 [Redis秒杀方案.md](../database/redis/Redis秒杀方案.md) 



### 核心点：

- 缓存
  - 本地缓存
  - 分布式缓存
  - CDN
- 异步化
- 锁
- 风控
- 限流、降级
  - 答题、排队
  - 强制：熔断



### 要点分析：

- 秒杀阶段
  - **秒杀前**
    - 用户大量访问秒杀商品，需添加秒杀商品缓存和静态资源CDN加速
  - **秒杀中**
  - 秒杀后

- 秒杀步骤
  - **风险控制 - 核心**
    - 请求监控
    - 用户监控
    - 增加秒杀答题，防止有秒杀器抢单
  - **库存锁定 - 核心**
    - 库存锁定成功后，一般就可以返回用户秒杀成功了
  - 生成订单
  - 短信通知
  - 更新统计数据等



### 库存扣减设计：

##### 方案：

- 下单扣库存
  - 优点：控制精准，性能好
  - 缺点：恶意下单请求，将导致商品无法正常得到售卖
- 付款扣库存
  - 优点：避免了 下单扣库存的问题
  - 缺点：下单成功的用户，可能无法支付成功，被别人购买走了
- 预扣库存：下单后预扣库存，在规定时间内未付款，则释放库存
  - 解决上面两种方式的问题
  - 一般业务用这种方式的比较多



##### 秒杀库存扣减方案选择：

- 由于参加秒杀的商品，一般都是“抢到就是赚到”，所以成功下单后却不付款的情况比较少，再加上卖家对秒杀商品的库存有严格限制，所以秒杀商品采用“下单减库存”更加合理。另外，理论上由于“下单减库存”比“预扣库存”以及涉及第三方支付的“付款减库存”在逻辑上更为简单，所以性能上更占优势。

- “下单减库存”在数据一致性上，主要就是保证大并发请求时库存数据不能为负数，也就是要保证数据库中的库存字段值不能为负数，一般我们有多种解决方案：一种是在应用程序中通过事务来判断，即保证减后库存不能为负数，否则就回滚；另一种办法是直接设置数据库的字段数据为无符号整数，这样减后库存字段值小于零时会直接执行 SQL 语句来报错；再有一种就是使用 CASE WHEN 判断语句，例如这样的 SQL 语句：

  ```sql
  UPDATE item SET inventory = CASE WHEN inventory >= xxx THEN inventory-xxx ELSE inventory END
  ```



##### 秒杀库存扣减优化：

> SKU：最小存货单位简称SKU是stock keeping unit的缩写，一般称其为项目编号。SKU被定义为保存库存控制的最小可用单位，例如纺织品中一个SKU通常表示规格、颜色、款式。在连锁零售门店中有时称单品为一个SKU，用SKU这一概念可以区分不同商品的不同属性，从而为商品采购、销售、物流管理、财务管理以及POS系统与MIS系统的开发提供极大的便利。 
>
> 单品：对一种商品而言，当其品牌、型号、配置、等级、花色、包装容量、单位、生产日期、保质期、用途、价格、产地等属性与其他商品存在不同时，可称为一个单品。



### 定位性能瓶颈：

JProfiler 和 Yourkit 这两个工具，它们可以列出整个请求中每个函数的 CPU 执行时间，可以发现哪个函数消耗的 CPU 时间最多，以便你有针对性地做优化